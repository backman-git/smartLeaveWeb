// Generated by CoffeeScript 1.12.3
(function() {
  var LeaveForm, LeaveSystem, LeaveSystemSingleton, Node, People, a1, a2, a3, b1, b2, b3, c1, c2, c3, clone, genHT_of_Tree, top;

  Node = require("./Node");

  People = require("./People");

  LeaveForm = require("./LeaveForm");

  LeaveSystem = (function() {
    function LeaveSystem(mainTreeRoot) {
      this.mainTreeRoot = mainTreeRoot;
      this.formsList = {};
      this.treeHT = genHT_of_Tree(this.mainTreeRoot);
    }

    LeaveSystem.prototype.getSecurityLevelByName = function(name) {
      return this.treeHT[name].value.level;
    };

    LeaveSystem.prototype.getPeopleNodeByName = function(name) {
      return clone(this.treeHT[name].value);
    };

    LeaveSystem.prototype.getSecurityLevelByFID = function(FID) {
      var name;
      name = this.getNameByFID(FID);
      return this.treeHT[name].value.level;
    };

    LeaveSystem.prototype.getNameByFID = function(FID) {
      FID = FID.split("-", 2);
      return FID[1];
    };

    LeaveSystem.prototype.showArchitecture = function() {
      var a, c, currentLevel, i, k, len, queue, ref, ref1, v;
      console.log("------------------------------------------\n");
      queue = [];
      if (this.mainTreeRoot === null) {
        console.log("Null");
      } else {
        queue.push(this.mainTreeRoot);
        currentLevel = this.mainTreeRoot.value.level;
        while (queue.length !== 0) {
          a = queue.shift();
          if (currentLevel < a.value.level) {
            currentLevel = a.value.level;
            console.log("\n");
          }
          process.stdout.write(a.value.name + ": ");
          ref = a.value.getWaitHQueue();
          for (k in ref) {
            v = ref[k];
            process.stdout.write("(" + k + "," + v + ") ");
          }
          ref1 = a.getChild();
          for (i = 0, len = ref1.length; i < len; i++) {
            c = ref1[i];
            queue.push(c);
          }
        }
      }
      return console.log("\n\n------------------------------------------\n");
    };

    LeaveSystem.prototype.addFormToFormsList = function(form) {
      if (form.name in this.formsList) {
        return this.formsList[form.name][form.fileID] = form;
      } else {
        this.formsList[form.name] = {};
        return this.formsList[form.name][form.fileID] = form;
      }
    };

    LeaveSystem.prototype.addNewForm = function(form) {
      this.treeHT[form.name].value.addFormToWaitHQueue(form);
      return this.addFormToFormsList(form);
    };

    LeaveSystem.prototype.getFormsList = function() {
      return clone(this.formsList);
    };

    LeaveSystem.prototype.getRole = function(name, FID) {
      var role;
      role = "";
      if (this.getSecurityLevelByName(name) === 0) {
        role = "personnel";
      } else if (this.getNameByFID(FID) === name) {
        role = "individual";
      } else if (this.getSecurityLevelByName(name) === this.getSecurityLevelByFID(FID)) {
        role = "deputy";
      } else if (this.getSecurityLevelByName(name) < this.getSecurityLevelByFID(FID)) {
        role = "boss";
      } else {
        role = "Error";
      }
      return role;
    };

    LeaveSystem.prototype.checkFormFinish = function(form) {
      var k, ref, v;
      ref = form.getState();
      for (k in ref) {
        v = ref[k];
        if (v === false) {
          return false;
        }
      }
      return true;
    };

    LeaveSystem.prototype.pushToFQ = function(form) {
      return this.treeHT["假單庫"].value.addFormToWaitHQueue(form);
    };

    LeaveSystem.prototype.submitFormByID = function(name, FID) {
      var deputy, form, p, pParent, role;
      role = this.getRole(name, FID);
      p = this.treeHT[name].value;
      form = p.retriveFormByFID(FID);
      form.setState(role, true);
      if (role === "personnel") {
        return p.addFormToWaitHQueue(form);
      } else if (role === "boss") {
        return this.pushToFQ(form);
      } else if (role === "deputy") {
        pParent = this.treeHT[name].getParent().value;
        return pParent.addFormToWaitHQueue(form);
      } else if (role === "individual") {
        deputy = this.treeHT[form.getRoleName("deputy")];
        deputy = deputy.value;
        return deputy.addFormToWaitHQueue(form);
      }
    };

    LeaveSystem.prototype.getPersonFormListByName = function(name) {
      return clone(this.formsList[name]);
    };

    LeaveSystem.prototype.getFormByFID = function(id) {
      var fList, name;
      name = this.getNameByFID(id);
      fList = this.getPersonFormListByName(name);
      return clone(fList[id]);
    };

    return LeaveSystem;

  })();

  genHT_of_Tree = function(root) {
    var HT, a, c, currentLevel, i, len, queue, ref;
    HT = {};
    queue = [];
    if (root === null) {
      console.log("Null");
    } else {
      queue.push(root);
      currentLevel = root.value.level;
      while (queue.length !== 0) {
        a = queue.shift();
        HT[a.value.name] = a;
        ref = a.getChild();
        for (i = 0, len = ref.length; i < len; i++) {
          c = ref[i];
          queue.push(c);
        }
      }
    }
    return HT;
  };

  clone = function(obj) {
    var flags, key, newInstance;
    if ((obj == null) || typeof obj !== 'object') {
      return obj;
    }
    if (obj instanceof Date) {
      return new Date(obj.getTime());
    }
    if (obj instanceof RegExp) {
      flags = '';
      if (obj.global != null) {
        flags += 'g';
      }
      if (obj.ignoreCase != null) {
        flags += 'i';
      }
      if (obj.multiline != null) {
        flags += 'm';
      }
      if (obj.sticky != null) {
        flags += 'y';
      }
      return new RegExp(obj.source, flags);
    }
    newInstance = new obj.constructor();
    for (key in obj) {
      newInstance[key] = clone(obj[key]);
    }
    return newInstance;
  };

  top = new Node(new People("假單庫", 0, "假單庫", "2017/6/6", 0), null);

  a1 = new Node(new People("劉采鑫", 1, "大隊長", "2017/1/1", 0), top);

  a2 = new Node(new People("沈俊興", 1, "大隊長", "2017/1/1", 0), top);

  a3 = new Node(new People("陳岳謄", 1, "大隊長", "2017/1/1", 0), top);

  b1 = new Node(new People("林子博", 2, "分隊長", "2017/1/1", 0), a1);

  b2 = new Node(new People("陳勝佑", 2, "分隊長", "2017/1/1", 0), a2);

  b3 = new Node(new People("何建樺", 2, "分隊長", "2017/1/1", 0), a3);

  c1 = new Node(new People("許木坤", 3, "隊員", "2017/1/1", 200), b1);

  c2 = new Node(new People("楊文宏", 3, "隊員", "2017/1/1", 0), b1);

  c3 = new Node(new People("王邦晟", 3, "隊員", "2017/1/1", 0), b3);

  LeaveSystemSingleton = (function() {
    var instance;

    function LeaveSystemSingleton() {}

    instance = null;

    top = null;

    LeaveSystemSingleton.build = function() {
      top = new Node(new People("假單庫", 0, "假單庫", "2017/6/6", 0), null);
      a1 = new Node(new People("劉采鑫", 1, "大隊長", "2017/1/1", 0), top);
      a2 = new Node(new People("沈俊興", 1, "大隊長", "2017/1/1", 0), top);
      a3 = new Node(new People("陳岳謄", 1, "大隊長", "2017/1/1", 0), top);
      b1 = new Node(new People("林子博", 2, "分隊長", "2017/1/1", 0), a1);
      b2 = new Node(new People("陳勝佑", 2, "分隊長", "2017/1/1", 0), a2);
      b3 = new Node(new People("何建樺", 2, "分隊長", "2017/1/1", 0), a3);
      c1 = new Node(new People("許木坤", 3, "隊員", "2017/1/1", 200), b1);
      c2 = new Node(new People("楊文宏", 3, "隊員", "2017/1/1", 0), b1);
      c3 = new Node(new People("王邦晟", 3, "隊員", "2017/1/1", 0), b3);
      return top;
    };

    LeaveSystemSingleton.get = function() {
      top = this.build();
      if (instance !== null) {
        return instance;
      } else {
        instance = new LeaveSystem(top);
        return instance;
      }
    };

    return LeaveSystemSingleton;

  })();

  module.exports = LeaveSystemSingleton;

}).call(this);
